################################################################################
# EcoFlow Power Management - Server Configuration
################################################################################
# This file configures the ORCHESTRATOR (server-side) that monitors your
# EcoFlow devices and decides when to send shutdown commands to agents.
#
# For AGENT (client-side) configuration, see the agents/ directory READMEs.
################################################################################

# ============================================================================
# ECOFLOW DEVELOPER API CREDENTIALS
# ============================================================================
# Required to connect to EcoFlow cloud and stream device data
# Obtain from: https://developer-eu.ecoflow.com or https://developer-us.ecoflow.com
# See README section "How to Obtain Developer API Access" for detailed instructions

ECOFLOW_ACCESS_KEY=""
ECOFLOW_SECRET_KEY=""

# ----------------------------------------------------------------------------
# Device Configuration
# ----------------------------------------------------------------------------
# Comma-separated list of your Device Serial Numbers
# Example format: R631ZEB4WH123456,R631ZEB4WH789012
ECOFLOW_DEVICE_LIST="R631ZEB4WH000001,R631ZEB4WH000002"

################################################################################

# ============================================================================
# LOCAL MQTT BROKER
# ============================================================================
# Your local MQTT broker where the orchestrator publishes normalized data
# and sends shutdown commands to agents

MQTT_HOST=mosquitto.local
MQTT_PORT=1883
MQTT_USER=
MQTT_PASS=

# EcoFlow MQTT topic base (usually no need to change)
ECOFLOW_BASE=bridge-ecoflow

# ============================================================================
# NOTIFICATION SETTINGS (Optional)
# ============================================================================
# Get notified about power events via Pushover and/or Telegram
# Both services are optional - system works without notifications

# Pushover (https://pushover.net)
# 1. Create account at pushover.net
# 2. Create an application to get API token
# 3. Find your user key in account settings
PUSHOVER_ENABLED=false
PUSHOVER_USER_KEY=""
PUSHOVER_API_TOKEN=""

# Telegram (https://core.telegram.org/bots)
# 1. Create bot via @BotFather on Telegram
# 2. Get bot token from @BotFather
# 3. Start chat with your bot and get chat ID from @userinfobot
TELEGRAM_ENABLED=false
TELEGRAM_BOT_TOKEN=""
TELEGRAM_CHAT_ID=""

# Notification Preferences (what to be notified about)
NOTIFY_GRID_LOSS=true           # Alert when grid power is lost
NOTIFY_SOC_WARNINGS=true        # Alert on low battery (every 2% drop)
NOTIFY_SHUTDOWN_COMMANDS=true   # Alert when shutdown sent to agents
NOTIFY_GRID_RESTORED=true       # Alert when power returns
NOTIFY_SYSTEM_EVENTS=true       # Alert on startup/connection issues

# ============================================================================
# POLICY CONFIGURATION (Shutdown Decision Logic)
# ============================================================================

# Battery percentage threshold
# If battery drops to or below this level while grid is disconnected,
# a shutdown sequence will be considered
POLICY_SOC_MIN=10

# Safety debounce timer (seconds)
# The critical condition (Grid Lost AND Low Battery) must remain active
# continuously for this duration before shutdown is triggered
# This prevents shutdowns during momentary power flickers
POLICY_DEBOUNCE_SEC=180

# Cooldown timer (seconds)
# After sending a shutdown command, wait this long before sending another
# command to the same device, even if battery remains low
# This prevents spamming shutdown commands
POLICY_COOLDOWN_SEC=300

# ============================================================================
# DEVICE-TO-AGENT MAPPING
# ============================================================================
# Maps EcoFlow device names to agent IDs that should be shut down
# Format: JSON object where keys are device names and values are arrays of agent IDs
#
# Device names come from your EcoFlow app (e.g., "Study", "Meterkast", "Office")
# Agent IDs must match the AGENT_ID configured on each client machine
#
# Example: When "Study" battery is critical, shutdown "pc-study" and "nas-study"
#          When "Office" battery is critical, shutdown "pc-office"

DEVICE_TO_AGENTS_JSON={"Study":["pc-study","nas-study"],"Office":["pc-office"]}

# For testing, you can add a simulated device:
# DEVICE_TO_AGENTS_JSON={"Study":["pc-study"],"SimulatedDevice":["test-agent"]}

################################################################################
# AGENT CONFIGURATION EXAMPLES (Client-Side)
################################################################################
# The following variables are used by AGENTS (client machines), not the server.
# Each agent should have its own configuration file or environment variables.
# These examples are provided for reference only.
#
# For detailed setup instructions, see:
#   - agents/linux/README.md
#   - agents/windows/README.md
#   - agents/macos/README.md
################################################################################

# ----------------------------------------------------------------------------
# LINUX AGENT EXAMPLE
# ----------------------------------------------------------------------------
# Copy these to your Linux machine's environment or systemd service file
#
# # Unique identifier for this agent (must match DEVICE_TO_AGENTS_JSON)
# AGENT_ID=pc-study
#
# # MQTT broker connection
# MQTT_BROKER=mosquitto.local
# MQTT_PORT=1883
#
# # Optional: Commands to run before shutdown (executed in order)
# PRE_SHUTDOWN_CMD_1="docker stop $(docker ps -q)"
# PRE_SHUTDOWN_CMD_2="systemctl stop microk8s"
# # PRE_SHUTDOWN_CMD_3="your-custom-command"
#
# # Shutdown command (default: "sudo shutdown -h +1")
# SHUTDOWN_CMD="sudo shutdown -h +1"
#
# # Optional: Custom abort command (default: "sudo shutdown -c")
# ABORT_CMD="sudo shutdown -c"

# ----------------------------------------------------------------------------
# WINDOWS AGENT EXAMPLE (PowerShell)
# ----------------------------------------------------------------------------
# Set these as environment variables or in your PowerShell script
#
# # Unique identifier for this agent (must match DEVICE_TO_AGENTS_JSON)
# $env:AGENT_ID = "pc-office"
#
# # MQTT broker connection
# $env:MQTT_BROKER = "mosquitto.local"
# $env:MQTT_PORT = "1883"
#
# # Optional: Commands to run before shutdown (executed in order)
# $env:PRE_SHUTDOWN_CMD_1 = "Stop-Service -Name 'vmms' -Force"
# $env:PRE_SHUTDOWN_CMD_2 = "docker stop $(docker ps -q)"
# # $env:PRE_SHUTDOWN_CMD_3 = "your-custom-command"
#
# # Shutdown command (default: "shutdown.exe /s /t 60 /f /c 'EcoFlow Critical Battery'")
# $env:SHUTDOWN_CMD = "shutdown.exe /s /t 60 /f /c 'EcoFlow Critical Battery'"
#
# # Optional: Custom abort command (default: "shutdown.exe /a")
# $env:ABORT_CMD = "shutdown.exe /a"

# ----------------------------------------------------------------------------
# MACOS AGENT EXAMPLE (Bash)
# ----------------------------------------------------------------------------
# Add these to your LaunchDaemon plist or shell environment
#
# # Unique identifier for this agent (must match DEVICE_TO_AGENTS_JSON)
# AGENT_ID=mac-studio
#
# # MQTT broker connection
# MQTT_BROKER=mosquitto.local
# MQTT_PORT=1883
#
# # Optional: Commands to run before shutdown (executed in order)
# PRE_SHUTDOWN_CMD_1="docker stop $(docker ps -q)"
# PRE_SHUTDOWN_CMD_2="brew services stop postgresql"
# # PRE_SHUTDOWN_CMD_3="your-custom-command"
#
# # Shutdown command (default: "sudo shutdown -h +1")
# SHUTDOWN_CMD="sudo shutdown -h +1"
#
# # Optional: Custom abort command (default: "sudo killall shutdown")
# ABORT_CMD="sudo killall shutdown"
